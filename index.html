<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Unnati Motors Spare Parts Ageing Dashboard">
    <title>Unnati Motors - Spare Parts Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f1f5f9;
        }
        
        body {
            background-color: #f1f5f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .header-section {
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            color: #ffffff !important;
            padding: 20px 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
            margin-bottom: 20px;
        }
        
        .header-section h1 {
            font-size: clamp(1.3rem, 5vw, 1.8rem);
            margin: 0;
            font-weight: 700;
            color: white !important;
            word-wrap: break-word;
        }
        
        .header-section .subtitle {
            font-size: clamp(0.8rem, 3vw, 0.9rem);
            opacity: 0.95;
            margin-top: 5px;
            color: white !important;
        }

        .header-section small {
            color: rgba(255, 255, 255, 0.9) !important;
            font-size: clamp(0.7rem, 2.5vw, 0.75rem);
            display: block;
            margin-top: 5px;
        }
        
        .dead-stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (max-width: 480px) {
            .dead-stock-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 8px;
            }
        }
        
        .dead-stock-card {
            background: white;
            padding: 12px;
            border-radius: 10px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        @media (max-width: 480px) {
            .dead-stock-card {
                padding: 10px;
            }
        }
        
        .dead-stock-card.current { border-left-color: #ef4444; }
        .dead-stock-card.last { border-left-color: #8b5cf6; }
        .dead-stock-card.last-to-last { border-left-color: #10b981; }
        .dead-stock-card.total { border-left-color: #f59e0b; }
        .dead-stock-card.liquidation { border-left-color: #f97316; }
        
        .dead-stock-card h6 {
            font-size: clamp(0.7rem, 2vw, 0.85rem);
            color: var(--secondary);
            margin-bottom: 6px;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .dead-stock-card .count {
            font-size: clamp(1.5rem, 5vw, 2rem);
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 3px;
            line-height: 1.1;
        }
        
        .dead-stock-card .value {
            font-size: clamp(0.65rem, 2vw, 0.85rem);
            font-weight: 800;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .dead-stock-card .btn {
            font-size: clamp(0.7rem, 2vw, 0.85rem);
            padding: clamp(4px, 2vw, 6px) clamp(6px, 3vw, 8px);
            margin-top: 6px;
        }
        
        .filter-card {
            background: white;
            padding: clamp(12px, 3vw, 15px);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 15px;
        }

        .filter-card label {
            font-weight: 600;
            font-size: clamp(0.8rem, 2.5vw, 0.9rem);
            margin-bottom: 6px;
        }

        .form-select, .form-control {
            font-size: clamp(0.8rem, 2.5vw, 0.95rem);
            border-radius: 8px;
        }

        .card {
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card-body {
            padding: clamp(12px, 3vw, 20px);
        }

        .table {
            font-size: clamp(0.7rem, 2vw, 0.9rem);
            margin-bottom: 0;
        }

        .table th {
            background-color: #1e293b;
            color: white;
            font-weight: 600;
            padding: clamp(8px, 2vw, 12px);
            font-size: clamp(0.65rem, 1.8vw, 0.85rem);
            white-space: nowrap;
            vertical-align: middle;
        }

        .table td {
            padding: clamp(8px, 2vw, 10px);
            vertical-align: middle;
        }

        .btn-sm {
            font-size: clamp(0.7rem, 2vw, 0.875rem);
            padding: clamp(4px, 1.5vw, 6px) clamp(6px, 2vw, 12px);
        }

        h5 {
            font-size: clamp(1rem, 3vw, 1.25rem);
        }

        h6 {
            font-size: clamp(0.85rem, 2.5vw, 1rem);
        }

        #partCategoryTable {
            position: relative;
        }

        #partCategoryTable thead th:first-child {
            position: sticky;
            left: 0;
            background-color: #1e293b !important;
            z-index: 25;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        #partCategoryTable tbody td:first-child {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 5;
            font-weight: 600;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        #partCategoryTable tfoot td:first-child {
            position: sticky;
            left: 0;
            background-color: #ff6f00 !important;
            z-index: 15;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }

        #partCategoryTable thead th:last-child {
            background-color: #ffc107 !important;
            color: #000 !important;
        }

        #partCategoryTable tbody td:last-child {
            background-color: #fff3cd !important;
            font-weight: bold;
        }

        #partCategoryTable tfoot td:last-child {
            background-color: #ff9800 !important;
            font-size: 1.2em;
        }

        @media (max-width: 576px) {
            .container-fluid {
                padding: 10px !important;
            }

            .header-section {
                padding: 15px 10px;
                margin-bottom: 15px;
            }

            .row {
                --bs-gutter-x: 0.75rem;
            }

            .col-lg-3, .col-md-6 {
                margin-bottom: 10px;
            }

            .table-responsive {
                font-size: 0.75rem;
            }

            .page-link {
                padding: 4px 8px;
                font-size: 0.75rem;
            }

            .dead-stock-card h6 {
                line-height: 1.3;
            }
        }

        @media (max-width: 768px) {
            .dead-stock-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }

        input, select, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .form-select, .form-control {
                min-height: 44px;
                padding: 8px 12px;
            }
        }

        .pagination {
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
        }

        .page-item {
            margin: 2px;
        }

        @media (max-width: 480px) {
            .card {
                border-radius: 8px;
            }

            .card-body {
                padding: 10px;
            }
        }

        .column-total-highlight {
            animation: pulse 2s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { background-color: #ff6f00; }
            50% { background-color: #ff9800; }
        }
    </style>
</head>
<body>
    <div class="container-fluid p-3 p-md-4">
        <!-- HEADER -->
        <div class="header-section">
            <div class="text-center">
                <h1> Unnati Motors Mahindra</h1>
                <p class="subtitle">Spare Parts Ageing Dashboard</p>
                <small style="opacity: 0.9;">Last Updated: {last_reload_time}</small>
            </div>
        </div>
        
        <!-- DEAD STOCK SECTION -->
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h4 style="margin-bottom: 15px; font-weight: 700; color: white;"> Dead Stock Monitor</h4>
                <div class="dead-stock-grid">
                    <div class="dead-stock-card current">
                        <h6>Current Month (As on Date)</h6>
                        <div class="count" id="deadStockCurrentAsOnCount">0</div>
                        <div class="value">‚Çπ<span id="deadStockCurrentAsOnValue">0</span></div>
                        <button class="btn btn-danger btn-sm w-100" id="btnDeadStockCurrent">Export</button>
                    </div>
                    <div class="dead-stock-card current">
                        <h6>Current Month (Complete)</h6>
                        <div class="count" id="deadStockCurrentCompleteCount">0</div>
                        <div class="value">‚Çπ<span id="deadStockCurrentCompleteValue">0</span></div>
                        <button class="btn btn-danger btn-sm w-100" id="btnDeadStockCurrentComplete">Export</button>
                    </div>
                    <div class="dead-stock-card last">
                        <h6>Last Month Dead Stock</h6>
                        <div class="count" id="deadStockLastCount">0</div>
                        <div class="value">‚Çπ<span id="deadStockLastValue">0</span></div>
                        <button class="btn btn-sm w-100" id="btnDeadStockLast" style="background-color: #8b5cf6; color: white;">Export</button>
                    </div>
                    <div class="dead-stock-card last-to-last">
                        <h6>Last to Last Month</h6>
                        <div class="count" id="deadStockLastToLastCount">0</div>
                        <div class="value">‚Çπ<span id="deadStockLastToLastValue">0</span></div>
                        <button class="btn btn-sm w-100" id="btnDeadStockLastToLast" style="background-color: #10b981; color: white;">Export</button>
                    </div>
                    <div class="dead-stock-card total">
                        <h6>Total Dead Stock</h6>
                        <div class="count" id="deadStockTotalCount">0</div>
                        <div class="value">‚Çπ<span id="deadStockTotalValue">0</span></div>
                        <button class="btn btn-warning btn-sm w-100" id="btnDeadStockAll">Export</button>
                    </div>
                    <div class="dead-stock-card liquidation">
                        <h6> Last Month Liquidation</h6>
                        <div class="count" id="lastMonthLiquidationCount">0</div>
                        <div class="value">‚Çπ<span id="lastMonthLiquidationValue">0</span></div>
                        <button class="btn btn-sm w-100" id="btnLastMonthLiquidation" style="background-color: #f97316; color: white;">Export</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPI SECTION -->
        <div class="row mt-3">
            <div class="col-lg-3 col-md-6">
                <div class="card bg-primary text-white h-100">
                    <div class="card-body">
                        <h6 style="color: white;">Total Stock at GNDP Value</h6>
                        <p style="font-size: clamp(1.5rem, 5vw, 2rem); font-weight: 700; margin: 0; color: white;" id="totalGndp">{formatted_gndp}</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="filter-card">
                    <label>Spare Ageing</label>
                    <select class="form-select form-select-sm selectpicker" id="movementCategory" multiple data-live-search="true" title="Select...">
                        {movement_categories_options}
                    </select>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="filter-card">
                    <label>Part Category</label>
                    <select class="form-select form-select-sm selectpicker" id="partCategory" multiple data-live-search="true" title="Select...">
                        {part_categories_options}
                    </select>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="filter-card">
                    <label>ABC Category</label>
                    <select class="form-select form-select-sm selectpicker" id="abcCategory" multiple data-live-search="true" title="Select...">
                        {abc_categories_options}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- MORE FILTERS -->
        <div class="row mt-2">
            <div class="col-lg-3 col-md-6">
                <div class="filter-card">
                    <label>RIS</label>
                    <select class="form-select form-select-sm selectpicker" id="ris" multiple data-live-search="true" title="Select...">
                        {ris_values_options}
                    </select>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="filter-card">
                    <label>Location</label>
                    <select class="form-select form-select-sm selectpicker" id="location" multiple data-live-search="true" title="Select...">
                        {locations_options}
                    </select>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="filter-card">
                    <label>Part No.</label>
                    <input type="text" class="form-control form-control-sm" id="partNumber" placeholder="Search Part...">
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="filter-card">
                    <div class="row g-2">
                        <div class="col-6">
                            <button id="applyFilters" class="btn btn-primary btn-sm w-100">
                                <i class="bi bi-check-circle"></i> Apply
                            </button>
                        </div>
                        <div class="col-6">
                            <button id="clearFilters" class="btn btn-warning btn-sm w-100">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SUMMARY TABLE -->
        <div class="card mt-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h5 class="mb-0">Location Wise Summary</h5>
                    <button id="downloadSummaryCsv" class="btn btn-info btn-sm">
                        <i class="bi bi-download"></i> Download
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm table-bordered" id="summaryTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Location</th>
                                <th colspan="2" class="text-center">0-90</th>
                                <th colspan="2" class="text-center">91-180</th>
                                <th colspan="2" class="text-center">181-365</th>
                                <th colspan="2" class="text-center">366-730</th>
                                <th colspan="2" class="text-center">730+</th>
                                <th class="text-center" style="background-color: #2196F3;">Row Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot class="table-secondary fw-bold"></tfoot>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- LOCATION WISE PART CATEGORY TABLE -->
        <div class="card mt-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                    <h5 class="mb-0">Part Category Table</h5>
                    <button id="downloadPartCategoryCsv" class="btn btn-info btn-sm">
                        <i class="bi bi-download"></i> Download
                    </button>
                </div>
                <div class="table-responsive" style="max-height: 600px; overflow: auto; border: 3px solid #2563eb; border-radius: 8px;">
                    <table class="table table-striped table-hover table-sm table-bordered mb-0" id="partCategoryTable">
                        <thead class="table-dark" style="position: sticky; top: 0; z-index: 20;">
                            <tr id="partCategoryHeaders">
                                <th>Location</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot class="column-total-highlight" style="background-color: #ff6f00; color: white; font-weight: bold; position: sticky; bottom: 0; z-index: 15; box-shadow: 0 -4px 10px rgba(0,0,0,0.3);">
                            <tr id="partCategoryTotal"></tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- DATA TABLE -->
        <div class="card mt-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h5 class="mb-0">Details <span id="recordCount" class="text-muted">(0 Records)</span></h5>
                    <button id="downloadCsv" class="btn btn-success btn-sm">
                        <i class="bi bi-download"></i> Download
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm" id="dataTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Part No.</th>
                                <th>Description</th>
                                <th>Location</th>
                                <th>Stock Qty</th>
                                <th>GNDP Value</th>
                                <th>Movement</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <nav aria-label="Pagination" class="mt-3">
                    <ul class="pagination pagination-sm justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/js/bootstrap-select.min.js"></script>
    
    <script>
        let currentPage = 1;
        const perPage = 25;
        let isDataLoaded = false;
        
        $(document).ready(function() {
            $('.selectpicker').selectpicker();
            setupEventListeners();
            
            setTimeout(() => {
                if (!isDataLoaded) {
                    loadAllData();
                    isDataLoaded = true;
                }
            }, 500);
        });
        
        function formatIndianNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            const actualValue = Math.round(num * 100000);
            let numStr = Math.abs(actualValue).toString();
            let lastThree = numStr.substring(numStr.length - 3);
            let otherNumbers = numStr.substring(0, numStr.length - 3);
            if (otherNumbers !== '') lastThree = ',' + lastThree;
            let result = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ',') + lastThree;
            return actualValue < 0 ? '-' + result : result;
        }
        
        function getFilters() {
            return {
                movementCategory: $('#movementCategory').val() || [],
                partCategory: $('#partCategory').val() || [],
                location: $('#location').val() || [],
                abcCategory: $('#abcCategory').val() || [],
                ris: $('#ris').val() || [],
                partNumber: $('#partNumber').val().trim()
            };
        }
        
        function buildQueryString(filters) {
            const params = new URLSearchParams();
            if (filters.movementCategory.length) params.append('movement_category', filters.movementCategory.join(','));
            if (filters.partCategory.length) params.append('part_category', filters.partCategory.join(','));
            if (filters.location.length) params.append('location', filters.location.join(','));
            if (filters.abcCategory.length) params.append('abc_category', filters.abcCategory.join(','));
            if (filters.ris.length) params.append('ris', filters.ris.join(','));
            if (filters.partNumber) params.append('part_number', filters.partNumber);
            return params.toString();
        }
        
        function loadAllData() {
            loadData();
            loadSummary();
            loadPartCategorySummary();
            loadDeadStockSummary();
            updateGNDP();
        }
        
        function loadDeadStockSummary() {
            const filters = getFilters();
            const queryString = buildQueryString(filters);
            
            $.ajax({
                url: `/dead-stock-summary?${queryString}`,
                method: 'GET',
                success: function(response) {
                    $('#deadStockCurrentAsOnCount').text(response.current_month_as_on_date.count);
                    $('#deadStockCurrentAsOnValue').text(formatIndianNumber(response.current_month_as_on_date.value));
                    $('#deadStockCurrentCompleteCount').text(response.current_month_complete.count);
                    $('#deadStockCurrentCompleteValue').text(formatIndianNumber(response.current_month_complete.value));
                    $('#deadStockLastCount').text(response.last_month.count);
                    $('#deadStockLastValue').text(formatIndianNumber(response.last_month.value));
                    $('#deadStockLastToLastCount').text(response.last_to_last_month.count);
                    $('#deadStockLastToLastValue').text(formatIndianNumber(response.last_to_last_month.value));
                    $('#deadStockTotalCount').text(response.total.count);
                    $('#deadStockTotalValue').text(formatIndianNumber(response.total.value));
                    if (response.last_month_liquidation) {
                        $('#lastMonthLiquidationCount').text(response.last_month_liquidation.count);
                        $('#lastMonthLiquidationValue').text(formatIndianNumber(response.last_month_liquidation.value));
                    }
                },
                error: function(error) {
                    console.error('Error loading dead stock summary:', error);
                }
            });
        }
        
        function loadSummary() {
            const filters = getFilters();
            const queryString = buildQueryString(filters);
            
            $.ajax({
                url: `/summary?${queryString}`,
                method: 'GET',
                success: function(response) {
                    $('#summaryTable tbody').empty();
                    $('#summaryTable tfoot').empty();
                    
                    response.summary.forEach(row => {
                        const rowTotal = row.aging_0_90_value + row.aging_91_180_value + 
                                       row.aging_181_365_value + row.aging_366_730_value + 
                                       row.aging_730_plus_value;
                        
                        $('#summaryTable tbody').append(`
                            <tr>
                                <td class="fw-bold">${row.location}</td>
                                <td class="text-end">${row.aging_0_90_count}</td>
                                <td class="text-end">${formatIndianNumber(row.aging_0_90_value)}</td>
                                <td class="text-end">${row.aging_91_180_count}</td>
                                <td class="text-end">${formatIndianNumber(row.aging_91_180_value)}</td>
                                <td class="text-end">${row.aging_181_365_count}</td>
                                <td class="text-end">${formatIndianNumber(row.aging_181_365_value)}</td>
                                <td class="text-end">${row.aging_366_730_count}</td>
                                <td class="text-end">${formatIndianNumber(row.aging_366_730_value)}</td>
                                <td class="text-end">${row.aging_730_plus_count}</td>
                                <td class="text-end">${formatIndianNumber(row.aging_730_plus_value)}</td>
                                <td class="text-end fw-bold" style="background-color: #E3F2FD;">${formatIndianNumber(rowTotal)}</td>
                            </tr>
                        `);
                    });
                    
                    const total = response.total;
                    const grandTotal = total.aging_0_90_value + total.aging_91_180_value + 
                                     total.aging_181_365_value + total.aging_366_730_value + 
                                     total.aging_730_plus_value;
                    
                    $('#summaryTable tfoot').html(`
                        <tr class="table-warning fw-bold">
                            <td class="fw-bold">TOTAL</td>
                            <td class="text-end">${total.aging_0_90_count}</td>
                            <td class="text-end">${formatIndianNumber(total.aging_0_90_value)}</td>
                            <td class="text-end">${total.aging_91_180_count}</td>
                            <td class="text-end">${formatIndianNumber(total.aging_91_180_value)}</td>
                            <td class="text-end">${total.aging_181_365_count}</td>
                            <td class="text-end">${formatIndianNumber(total.aging_181_365_value)}</td>
                            <td class="text-end">${total.aging_366_730_count}</td>
                            <td class="text-end">${formatIndianNumber(total.aging_366_730_value)}</td>
                            <td class="text-end">${total.aging_730_plus_count}</td>
                            <td class="text-end">${formatIndianNumber(total.aging_730_plus_value)}</td>
                            <td class="text-end" style="background-color: #FFD54F;">${formatIndianNumber(grandTotal)}</td>
                        </tr>
                    `);
                },
                error: function(error) {
                    console.error('Error loading summary:', error);
                }
            });
        }
        
        function loadPartCategorySummary() {
            const filters = getFilters();
            const queryString = buildQueryString(filters);
            
            console.log('üîç Loading Part Category Summary...');
            
            $.ajax({
                url: `/location-part-category-summary?${queryString}`,
                method: 'GET',
                success: function(response) {
                    console.log('‚úÖ Part Category Data Received:', response);
                    
                    const partCategories = response.part_categories;
                    console.log('üìä Total Part Categories Found:', partCategories.length);
                    console.log('üìã Part Categories:', partCategories);
                    
                    let headerHtml = '<th style="position: sticky; left: 0; background-color: #1e293b !important; z-index: 25; box-shadow: 2px 0 5px rgba(0,0,0,0.1);">Location</th>';
                    
                    partCategories.forEach((cat, index) => {
                        console.log(`Column ${index + 1}: ${cat}`);
                        headerHtml += `<th class="text-center" style="min-width: 100px;">${cat}</th>`;
                    });
                    
                    headerHtml += '<th class="text-center" style="background-color: #ffc107; color: #000; min-width: 120px;">Row Total</th>';
                    $('#partCategoryHeaders').html(headerHtml);
                    
                    $('#partCategoryTable tbody').empty();
                    response.summary.forEach((row, rowIndex) => {
                        let rowHtml = `<tr><td class="fw-bold" style="position: sticky; left: 0; background-color: white; z-index: 5; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">${row.location}</td>`;
                        let rowTotal = 0;
                        
                        partCategories.forEach(cat => {
                            const value = row[cat] || 0;
                            rowHtml += `<td class="text-end">${formatIndianNumber(value)}</td>`;
                            rowTotal += value;
                        });
                        
                        rowHtml += `<td class="text-end fw-bold" style="background-color: #fff3cd; color: #000;">${formatIndianNumber(rowTotal)}</td></tr>`;
                        $('#partCategoryTable tbody').append(rowHtml);
                        console.log(`Row ${rowIndex + 1} (${row.location}): Total = ${formatIndianNumber(rowTotal)}`);
                    });
                    
                    console.log('üßÆ Calculating Column Totals...');
                    let footerHtml = '<tr style="background-color: #ff6f00; color: white; font-size: 1.15em; font-weight: bold;">';
                    footerHtml += '<td style="position: sticky; left: 0; background-color: #ff6f00 !important; z-index: 15; box-shadow: 2px 0 5px rgba(0,0,0,0.2); padding: 14px; font-size: 1.1em;">Total</td>';
                    
                    let grandTotal = 0;
                    
                    partCategories.forEach((cat, index) => {
                        const columnTotal = response.total[cat] || 0;
                        console.log(`‚úÖ ${cat}: ${formatIndianNumber(columnTotal)}`);
                        footerHtml += `<td class="text-end" style="padding: 14px; background-color: #ff6f00; color: white; font-weight: bold; border-left: 1px solid rgba(255,255,255,0.2);">${formatIndianNumber(columnTotal)}</td>`;
                        grandTotal += columnTotal;
                    });
                    
                    console.log(`üéØ GRAND TOTAL: ${formatIndianNumber(grandTotal)}`);
                    footerHtml += `<td class="text-end" style="background-color: #ff9800; color: white; padding: 14px; font-size: 1.3em; font-weight: bold; border: 2px solid white;">${formatIndianNumber(grandTotal)}</td></tr>`;
                    
                    $('#partCategoryTable tfoot').html(footerHtml);
                    
                    console.log('‚úÖ Part Category Summary Loaded Successfully!');
                    console.log(`üìä Summary: ${partCategories.length} categories, Grand Total: ${formatIndianNumber(grandTotal)}`);
                },
                error: function(error) {
                    console.error('‚ùå Error loading part category summary:', error);
                }
            });
        }
        
        function loadData() {
            const filters = getFilters();
            const queryString = buildQueryString(filters);
            
            $.ajax({
                url: `/data?page=${currentPage}&per_page=${perPage}&${queryString}`,
                method: 'GET',
                success: function(response) {
                    $('#dataTable tbody').empty();
                    
                    response.data.forEach(row => {
                        $('#dataTable tbody').append(`
                            <tr>
                                <td>${row['Part No.'] || ''}</td>
                                <td>${row['Part Description'] || ''}</td>
                                <td>${row.Location || ''}</td>
                                <td>${row['Stock Qty'] || ''}</td>
                                <td>${row['Stock  at GNDP (Rs.) (In Lac)  '] || ''}</td>
                                <td>${row['Movement Category P (2)'] || ''}</td>
                            </tr>
                        `);
                    });
                    
                    updatePagination(response.total_pages, response.page);
                    $('#recordCount').text(`(${response.total_records} Records)`);
                },
                error: function(error) {
                    console.error('Error loading data:', error);
                }
            });
        }
        
        function updateGNDP() {
            const filters = getFilters();
            const params = new URLSearchParams();
            
            if (filters.movementCategory.length) params.append('movement_category', filters.movementCategory.join(','));
            if (filters.partCategory.length) params.append('part_category', filters.partCategory.join(','));
            if (filters.location.length) params.append('location', filters.location.join(','));
            if (filters.abcCategory.length) params.append('abc_category', filters.abcCategory.join(','));
            if (filters.ris.length) params.append('ris', filters.ris.join(','));
            if (filters.partNumber) params.append('part_number', filters.partNumber);
            
            const queryString = params.toString();
            
            $.ajax({
                url: `/calculate-gndp?${queryString}`,
                method: 'GET',
                success: function(response) {
                    $('#totalGndp').text(formatIndianNumber(response.total_gndp));
                },
                error: function(error) {
                    console.error('Error updating GNDP:', error);
                }
            });
        }
        
        function updatePagination(totalPages, currentPage) {
            $('#pagination').empty();
            if (totalPages === 0) return;
            
            $('#pagination').append(`
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">Prev</a>
                </li>
            `);
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    $('#pagination').append(`
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    $('#pagination').append(`<li class="page-item disabled"><a class="page-link" href="#">...</a></li>`);
                }
            }
            
            $('#pagination').append(`
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
                </li>
            `);
        }
        
        function setupEventListeners() {
            $('#applyFilters').click(function() {
                currentPage = 1;
                loadAllData();
            });
            
            $('#clearFilters').click(function() {
                $('.selectpicker').selectpicker('deselectAll');
                $('#partNumber').val('');
                
                currentPage = 1;
                loadAllData();
            });
            
            $(document).on('click', '.page-link', function(e) {
                e.preventDefault();
                const page = parseInt($(this).data('page'));
                if (page > 0) {
                    currentPage = page;
                    loadData();
                    $('html, body').animate({scrollTop: 0}, 'smooth');
                }
            });
            
            $('#downloadCsv').click(function() {
                const filters = getFilters();
                const queryString = buildQueryString(filters);
                window.location.href = `/download-csv?${queryString}`;
            });
            
            $('#downloadSummaryCsv').click(function() {
                const filters = getFilters();
                const queryString = buildQueryString(filters);
                window.location.href = `/download-summary-csv?${queryString}`;
            });
            
            $('#downloadPartCategoryCsv').click(function() {
                const filters = getFilters();
                const queryString = buildQueryString(filters);
                window.location.href = `/download-part-category-csv?${queryString}`;
            });
            
            $('#btnDeadStockCurrent').click(function() {
                const filters = getFilters();
                const queryString = buildQueryString(filters);
                window.location.href = `/download-dead-stock-csv?dead_stock_category=current_month_as_on_date&${queryString}`;
            });
            
            $('#btnDeadStockCurrentComplete').click(function() {
                const filters = getFilters();
                const queryString = buildQueryString(filters);
                window.location.href = `/download-dead-stock-csv?dead_stock_category=current_month_complete&${queryString}`;
            });
            
            $('#btnDeadStockLast').click(function() {
                const filters = getFilters();
                const queryString = buildQueryString(filters);
                window.location.href = `/download-dead-stock-csv?dead_stock_category=last_month&${queryString}`;
            });
            
            $('#btnDeadStockLastToLast').click(function() {
                const filters = getFilters();
                const queryString = buildQueryString(filters);
                window.location.href = `/download-dead-stock-csv?dead_stock_category=last_to_last_month&${queryString}`;
            });
            
            $('#btnDeadStockAll').click(function() {
                const filters = getFilters();
                const queryString = buildQueryString(filters);
                window.location.href = `/download-dead-stock-csv?dead_stock_category=all&${queryString}`;
            });
            
            $('#btnLastMonthLiquidation').click(function() {
                const filters = getFilters();
                const queryString = buildQueryString(filters);
                window.location.href = `/download-last-month-liquidation-csv?${queryString}`;
            });
        }
    </script>
</body>
</html>
